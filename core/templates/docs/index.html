{% extends 'docs/base.html' %}
{% load static %}

{% block header %}
    {% include 'docs/heeader.html' %}
{% endblock header %}

{% block content %}
    <div class="docs-wrapper">
        <div id="docs-sidebar" class="docs-sidebar">
            <div class="top-search-box d-lg-none p-3">
                <form class="search-form">
                    <input type="text" placeholder="Search the docs..." name="search" class="form-control search-input">
                    <button type="submit" class="btn search-btn" value="Search"><i class="fas fa-search"></i></button>
                </form>
            </div>
            <nav id="docs-nav" class="docs-nav navbar">
                <ul class="section-items list-unstyled nav flex-column pb-3">
                    <li class="nav-item section-title"><a class="nav-link scrollto active" href="#section-1"><span
                            class="theme-icon-holder mr-2"><i class="fas fa-map-signs"></i></span>Overview</a></li>
                    <li class="nav-item"><a class="nav-link scrollto" href="#section-1">About USSD External Channel </a>
                    </li>
                    <li class="nav-item"><a class="nav-link scrollto" href="#item-1-1">Technologies</a></li>
                    <li class="nav-item"><a class="nav-link scrollto" href="#item-1-2">Coding Conventions</a></li>
                    <li class="nav-item section-title mt-3"><a class="nav-link scrollto" href="#section-2"><span
                            class="theme-icon-holder mr-2"><i class="fas fa-arrow-down"></i></span>Installation</a></li>
                    <li class="nav-item"><a class="nav-link scrollto" href="#item-2-1">Database Setup</a></li>
                    <li class="nav-item"><a class="nav-link scrollto" href="#item-2-2">User Interface Setup</a></li>
                    <li class="nav-item"><a class="nav-link scrollto" href="#item-2-3">Running Channel and RapidPro
                        locally together </a></li>
                    <li class="nav-item section-title mt-3"><a class="nav-link scrollto" href="#section-3"><span
                            class="theme-icon-holder mr-2"><i class="fas fa-cogs"></i></span>Intergration with RapidPro</a>
                    </li>
                    <li class="nav-item"><a class="nav-link scrollto" href="#item-3-1">Channel Configurations</a></li>
                    <li class="nav-item"><a class="nav-link scrollto" href="#item-3-2">Aggregator Handler
                        Configurations</a></li>
                    <li class="nav-item"><a class="nav-link scrollto" href="#item-3-5">Clear Timeout sessions</a></li>
                    <li class="nav-item"><a class="nav-link scrollto" href="#item-3-3">RapidPro USSD Flow Setup and best Practices</a></li>
                    <li class="nav-item"><a class="nav-link scrollto" href="#item-3-4">Deployment (enable Live session tracking table)</a></li>
                    <li class="nav-item section-title mt-3"><a class="nav-link scrollto" href="#section-4"><span
                            class="theme-icon-holder mr-2"><i class="fas fa-tv"></i></span>Features</a></li>
                    <li class="nav-item"><a class="nav-link scrollto" href="#item-4-1">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link scrollto" href="#item-4-2">User Profile</a></li>
                </ul>

            </nav><!--//docs-nav-->
        </div><!--//docs-sidebar-->
        <div class="docs-content">
            <div class="container">
                <article class="docs-article" id="section-1">
                    <header class="docs-header">
                        <h3 class="docs-heading"><span>External USSD Channel</span><span
                                class="docs-time">Last updated: 2020-09-30</span>
                        </h3>
                        <section class="docs-intro">
                            <p>
                                RapidPro External USSD channel is an open source software that uses RapidPro's Generic
                                External Channel API to relay messages between RapidPro and USSD supported devices
                                through USSD aggregator APIs that are configurable within the channel.

                            </p>
                        </section><!--//docs-intro-->

                        <!--<h5>Github Code Example:</h5>
                        <p>You can <a class="theme-link" href="https://gist.github.com/" target="_blank">embed your code
                            snippets using Github gists</a></p>
                        <div class="docs-code-block">
                            <script src="https://gist.github.com/xriley/fce6cf71edfd2dadc7919eb9c98f3f17.js"></script>

                        </div>

                        <h5>Highlight.js Example:</h5>
                        <p>You can <a class="theme-link" href="https://github.com/highlightjs/highlight.js"
                                      target="_blank">embed your code snippets using highlight.js</a> It supports <a
                                class="theme-link" href="https://highlightjs.org/static/demo/" target="_blank">185
                            languages and 89 styles</a>.</p>
                        <p>This template uses <a class="theme-link" href="https://highlightjs.org/static/demo/"
                                                 target="_blank">Atom One Dark</a> style for the code blocks: <br><code>&#x3C;link
                            rel=&#x22;stylesheet&#x22; href=&#x22;//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.2/styles/atom-one-dark.min.css&#x22;&#x3E;</code>
                        </p>
                        <div class="docs-code-block">
							<pre class="shadow-lg rounded"><code class="json hljs">[
  {
    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"apples"</span>,
    <span class="hljs-attr">"count"</span>: [<span class="hljs-number">12000</span>, <span
                                        class="hljs-number">20000</span>],
    <span class="hljs-attr">"description"</span>: {<span class="hljs-attr">"text"</span>: <span class="hljs-string">"..."</span>, <span
                                        class="hljs-attr">"sensitive"</span>: <span class="hljs-literal">false</span>}
  },
  {
    <span class="hljs-attr">"title"</span>: <span class="hljs-string">"oranges"</span>,
    <span class="hljs-attr">"count"</span>: [<span class="hljs-number">17500</span>, <span
                                        class="hljs-literal">null</span>],
    <span class="hljs-attr">"description"</span>: {<span class="hljs-attr">"text"</span>: <span class="hljs-string">"..."</span>, <span
                                        class="hljs-attr">"sensitive"</span>: <span class="hljs-literal">false</span>}
  }
]


</code></pre>
                        </div>-->


                    </header>
                    <section class="docs-section" id="item-1-1">
                        <h2 class="section-heading">Technologies</h2>
                        <p>
                            The minimum requirements and technologies for the channel service are the same as those for
                            RapidPro:
                            It is recommended to first have a grasp about the basics of how these technologies work and
                            the
                            programming languages they use before you can contribute to the code base.
                        </p>

                        <h5>Frontend</h5>
                        <ul>
                            <li>
                                <strong class="mr-1"><a href="https://www.djangoproject.com">Python - Django</a>:
                                </strong>
                                <p>
                                    The entire frontend is built in django, we try to use the latest version of django
                                    shortly in about 2 months when its out.
                                </p>
                            </li>

                        </ul>
                        <h5>Backend</h5>
                        <ul>
                            <li>
                                <strong class="mr-1"><a href="http://www.postgresql.org/">PostgreSQL</a>:
                                </strong>
                                <p>
                                    Although you can use other RDBMS together with Django as described <a
                                        href="https://docs.djangoproject.com/en/3.1/ref/databases/">Here</a>,
                                    We recommend and depend on PostgreSQL as our SQL server.
                                </p>
                            </li>
                            <li>
                                <strong class="mr-1"><a href="http://redis.io/">Redis</a>:
                                </strong>
                                <p>
                                    We use Redis as a reliable and fast broker to provide a locking mechanism during
                                    transactions between
                                    our Channel and RapidPro.
                                    It should be noted that the core logic of the system will not work when Redis is not
                                    installed.
                                </p>
                            </li>

                        </ul>
                    </section><!--//section-->

                    <section class="docs-section" id="item-1-2">
                        <h2 class="section-heading">Coding Conventions</h2>
                        <p>
                            We generally try to adhere to the practices set forth by the Django, Python communities.
                        </p>
                        <h5>Code Reviews & Pull Requests</h5>
                        <p>
                            All committed code must be code reviewed via a formal pull request. Whether it is a new
                            feature work or bug fixes, all code should be written on a branch apart from master, then a
                            pull request should be opened to review those changes before committing to master. Any code
                            on the master branch is considered ready for live deployment.
                        </p>
                        <h5>Modularity of code</h5>
                        <p>We try to keep related code together in less coupled modules that can be modified/removed
                            from the core system at any time without grave effects on most parts of the system</p>
                    </section><!--//section-->

                    </section><!--//section-->

                </article>

                <article class="docs-article" id="section-2">
                    <header class="docs-header">
                        <h1 class="docs-heading">Installation</h1>
                        <section class="docs-intro">
                            <p>
                                In order to use the USSD External Channel Service, you must have a fully installed and
                                working instance of the supported RapidPro system (i.e. post v5). Please follow the
                                setup instructions found <a href="http://rapidpro.github.io/rapidpro/docs/">Here</a>:
                                <br><br>
                                Once RapidPro is up and running, you can install and configure the channel service as
                                detailed below.
                            </p>
                        </section>
                    </header>
                    <p class="docs-section" id="item-2-1">
                    <h2 class="section-heading">Database Setup</h2>
                    <p>
                        Create a new database user called <code>ussd_user</code> for postgreSQL
                        <br>
                        You can create one by running this command in your terminal
                    <div class="docs-code-block rounded">
                        <code class="code-samples hljs">
                            $createuser ussd_user --pwprompt -d
                        </code>
                    </div>
                    Create database named <code>ussd</code> by running the command below
                    <div class="docs-code-block rounded">
                        <code class="code-samples hljs">
                            $createdb ussd
                        </code>
                    </div>

                    If all is well with your PostgreSQL then your database is ready.
                    </p>
                    </section><!--//section-->

                    <section class="docs-section" id="item-2-2">
                        <h2 class="section-heading">User Interface Setup</h2>
                        <p>
                            Go on to clone the project <a
                                href="https://github.com/dsmagicug/rapidpro-external-ussd-channel">Here</a> by running
                            the command below.

                            You can create one by running this command in your terminal
                        <div class="shadow-lg rounded">
                            <code class="code-samples hljs">
                                $createdb ussd
                            </code>
                        </div>
                        </p>
                        <p>
                        <div class="docs-code-block">
                            <div class="shadow-lg rounded">
                                <code class="code-samples hljs">
                                    $git clone https://github.com/dsmagicug/rapidpro-external-ussd-channel.git<br>
                                    $cd rapidpro-external-ussd-channel
                                </code>
                            </div>
                        </div>
                        </p>
                        <h2 class="section-heading">Building a virtual environment</h2>
                        <p>
                            This step is optional but it's highly recommended to use a virtual environment to run your
                            External USSD channel installation. The pinned python dependencies for the project can be
                            found in pip-freeze.txt. You can build the recommended environment as follows (from the root
                            External USSD channel installation directory)
                        </p>
                        <div class="docs-code-block">
                            <div class="shadow-lg rounded">
                                <code class="code-samples hljs">
                                    $ virtualenv -p python3 env<br>
                                    $ source env/bin/activate<br>
                                    $(env) $ pip install -r pip-freeze.txt
                                </code>
                            </div>
                        </div>
                        <h2 class="section-heading">sync your database</h2>
                        <p>
                            Still inside your project root directory, run the following command
                        </p>
                        <div class="docs-code-block">
                            <div class="shadow-lg rounded">
                                <code class="code-samples hljs">
                                    $python manage.py migrate
                                </code>
                            </div>
                        </div>
                        <p>
                            Django countries requires you populate the Countries table with the latest country data using
                        </p>
                        <div class="docs-code-block">
                            <div class="shadow-lg rounded">
                                <code class="code-samples hljs">
                                    $python manage.py update_countries_plus
                                </code>
                            </div>
                        </div>
                        <h2 class="section-heading">Start django server</h2>
                        <p>
                            Start the django (rocket) server by running the code below.<br>
                            Then visit <code><a href="#">http://localhost:8000</a></code>
                        </p>
                        <div class="docs-code-block">
                            <div class="shadow-lg rounded">
                                <code class="code-samples hljs">
                                    $python manage.py runserver
                                </code>
                            </div>
                        </div>
                    </section><!--//section-->

                    <section class="docs-section" id="item-2-3">
                        <h5 class="section-heading">Running alongside RapidPro on the same machine</h5>
                        <p>
                            In most cases, you may want to install both <a
                                href="https://rapidpro.github.io/rapidpro/docs/development/">RapidPro</a> and the
                            External USSD channel on the same server instance.<br>
                            To set up RapidPro follow the instructions <a
                                href="https://rapidpro.github.io/rapidpro/docs/development/">Here</a><br>
                            Since they are both Django applications, you have to run <code>python
                            manage.py runserver</code> for each of them. This will return an error <code
                                style="color:darkred">Address already in use</code>, since the Django development server
                            by default runs on port <code>8000</code>.<br><br>
                            The trick here is starting each on a different port as described in the django
                            documentation <a href="https://docs.djangoproject.com/en/3.1/ref/django-admin/">Here</a>.
                            For our example, we shall use port <code>5000</code> to run the External USSD Channel
                            development server.<br>
                            Inside the External USSD channel project directory, run<br>
                            <code>python manage.py 0.0.0.0:5000</code><br>
                            Visit http://localhost:5000<br><br>
                            We recommend that you leave RapidPro use the default port <code>8000</code>
                        </p>
                    </section><!--//section-->
                </article><!--//docs-article-->


                <article class="docs-article" id="section-3">
                    <header class="docs-header">
                        <h1 class="docs-heading">Integration with RapidPro</h1>
                        <section class="docs-intro">
                            <p>
                                For this step, You need an online RapidPro instance (it could be on the same server
                                instance as the USSD channel on the same machine)
                                as described <a href="#item-2-3">above</a>.<br><br>
                                Go to RapidPro and select External API as demonstrated in the image below.
                                <figure class="figure docs-figure py-3">
                                    <a href="{% static 'assets/img/demo/external-channel-icon.png' %}"
                                       data-title="Channel Configs"
                                       data-toggle="lightbox"><img class="figure-img img-fluid shadow rounded"
                                                                   src="{% static 'assets/img/demo/external-channel-icon.png' %}"
                                                                   alt="" style="width: 600px;"></a>
                                    <figcaption class="figure-caption mt-3"><i class="fas fa-image mr-2"></i>
                                        External API channel Option in RapidPro
                                    </figcaption>
                                </figure>
                                <br>
                                Proceed to the External API form as shown in the image below
                                <br>
                                <figure class="figure docs-figure py-3">
                                    <a href="{% static 'assets/img/demo/claim-form.png' %}" data-title="Channel Configs"
                                       data-toggle="lightbox"><img class="figure-img img-fluid shadow rounded"
                                                                   src="{% static 'assets/img/demo/claim-form.png' %}"
                                                                   alt="" style="width: 600px;"></a>
                                    <figcaption class="figure-caption mt-3"><i class="fas fa-image mr-2"></i>
                                        External API channel Option in RapidPro
                                    </figcaption>
                                </figure>
                                <br>
                                Head back to the External USSD Channel Web interface when you are sure the above steps.
                            </p>
                        </section><!--//docs-intro-->
                    </header>
                    <section class="docs-section" id="item-3-1">
                        <h2 class="section-heading">Channel Configurations</h2>
                        <ul>
                            <li>Visit the web interface of RapidPro External USSD Channel system</li>
                            <li>Create an account under <code>Register</code> if you haven't</li>
                            <li>Login.</li>
                        </ul>
                        <p>
                            <figure class="figure docs-figure py-3">
                                <a href="{% static 'assets/img/demo/channel_conf.png' %}" data-title="Channel Configs"
                                   data-toggle="lightbox"><img class="figure-img img-fluid shadow rounded"
                                                               src="{% static 'assets/img/demo/channel_conf.png' %}"
                                                               alt="" style="width: 600px;"></a>
                                <figcaption class="figure-caption mt-3"><i class="fas fa-image mr-2"></i>Channel
                                    Configuration form
                                </figcaption>
                            </figure>
                            <br>
                            Continue to <code>CHANNEL CONFIGS</code>on the side menu(as shown in the image above) to
                            configure a channel closely following the instructions on the Step by step form. Note that
                            you will need to configure the following for your channel to work properly.
                            <br>
                            <ol>
                                <li>
                                    <code>Send&nbsp;URL</code>
                        <p>
                            This is a URL which RapidPro will call when sending an outgoing message. This URL will be generated as you input your local server URL required.<br><br>
                            The format of the SEND URL will be like this;
                            <code>http://yourmachine/adaptor/send-url</code>.
                            Copy this link, head to RapidPro's External API form and paste it under the <code>SEND
                            URL</code> field as shown below.
                            <figure class="figure docs-figure py-3">
                                <a href="{% static 'assets/img/demo/send-url.png' %}"
                                   data-title="RapidPro External API service config instructions page"
                                   data-toggle="lightbox"><img class="figure-img img-fluid shadow rounded"
                                                               src="{% static 'assets/img/demo/send-url.png' %}" alt=""
                                                               style="width: 600px;"></a>
                                <figcaption class="figure-caption mt-3"><i class="fas fa-image mr-2"></i>RapidPro
                                    external service conf Instructions screen
                                </figcaption>
                            </figure>
                        </p>
                        </li>
                        <li>
                            <p>
                                Fill the rest of RapidPro's External API configuration form and then submit it. You will
                                be presented with instructions on how to setup an external service (The USSD External
                                Channel) similar to the image below.
                                <figure class="figure docs-figure py-3">
                                    <a href="{% static 'assets/img/demo/external_service.png' %}"
                                       data-title="RapidPro External API service config instructions page"
                                       data-toggle="lightbox"><img class="figure-img img-fluid shadow rounded"
                                                                   src="{% static 'assets/img/demo/external_service.png' %}"
                                                                   alt="" style="width: 600px;"></a>
                                    <figcaption class="figure-caption mt-3"><i class="fas fa-image mr-2"></i>Receive URL
                                        required from RapidPro at step4 below
                                    </figcaption>
                                </figure><br>
                                <b>NOTE:</b> Before submiting RapidPro's External API configuration form, make sure you add cgi params.
                                <br>
                                <code style="color:blue">session_status={% templatetag openvariable %}session_status}}&to_no_plus={% templatetag openvariable %}to_no_plus}}&from_no_plus={% templatetag openvariable %}from_no_plus}}</code>
                                <br>
                                to the Request Body field. These are required when rapidPro is making a request to the USSD external channel in addition to the default
                                <code style="color:blue">id={% templatetag openvariable %}id}}&text={% templatetag openvariable %}text}}&to={% templatetag openvariable %}to}}&from={% templatetag openvariable %}from}}&channel={% templatetag openvariable %}channel}}</code>.
                                <br><br>Your configuration will not work if these cgi-params are not set at this level since the channel uses <code>session_status</code> within the request from RapidPro to tell if the interaction is still ongoing or completed so as it initiates the right USSD menu to the end user device. If you are confused, just copy
                                <br>
                                <code style="color:blue">id={% templatetag openvariable %}id}}&text={% templatetag openvariable %}text}}&to={% templatetag openvariable %}to}}&to_no_plus={% templatetag openvariable %}to_no_plus}}&from={% templatetag openvariable %}from}}&from_no_plus={% templatetag openvariable %}from_no_plus}}&channel={% templatetag openvariable %}channel}}&session_status={% templatetag openvariable %}session_status}}</code>
                                and paste it in Request Body field.
                            </p>
                        </li>
                        <li>
                            <p>
                                On the above instructions page in RapidPro, we are ONLY interested in the <code>RECEIVE
                                URL</code>. Copy it and head back to our USSD channel form.
                            </p>
                        </li>
                        <li>
                            <p>
                                Click Next and paste the URL there. (make sure the <code style="color:blue">https://app.rapidpro.io</code>
                                part of this URL is substituted with the correct link to your RapidPro instance and
                                please leave the other part <code style="color:blue">/c/ex/......../receive</code>
                                untouched).
                            </p>
                        </li>
                        <li>
                            <p>
                                Click Next to configure the Channel's <code>Max-timeout</code> (default=10s). This is
                                the time in seconds our channel shall wait for a response from RapidPro. It will time
                                out if RapidPro does not reply within that time interval.
                            </p>
                        </li>
                        <li>
                            <p>
                                Click Next to configure the <code>Trigger word</code> (default=USSD). This is a keyword
                                to trigger a given flow execution in Rapidpro
                                when a contact starts a new session when it isn't involved with any RapidPro flows yet.<br>
                                Please <b>note</b> that in RapidPro, a keyword can be set to trigger only one flow at a time.
                                So we advise that if multiple choices of flows are available to be used in USSD,
                                The Rapidpro flow creator should create a flow which routes to other flows then assign this keyword to that flow.
                                i.e a User on USSD will be presented with options of which flow to participate in then get routed accordingly.
                                This way one keyword can trigger the router flow, and routes will be made according to user replies.
                            </p>
                        </li>
                        <li>
                            <p>
                                Submit the form to save the channel configurations.
                            </p>
                        </li>
                        </ol>
                        </p>
                    </section>

                    <section class="docs-section" id="item-3-2">
                        <h2 class="section-heading">Aggregator Handler Configurations</h2>
                        <p>
                            Since different USSD aggregator APIs have different Request/Response formats, this channel standardizes these formats into one understood by RapidPro.<br>
                            This is achieved through configuring handlers for each of the aggregator APIs that you want to use.<br>
                            To set up a Handelr;<br><br>
                            Go to <code>HANDLERS</code> on your side menu, click <code>Add Handler</code> button. You
                            will be
                            presented with a form(as shown in the image below).<br>
                            <tr>
                                <td>
                                    <figure class="figure docs-figure py-3">
                                        <a href="{% static 'assets/img/demo/add_handler.png' %}"
                                           data-title="RapidPro External API service config instructions page"
                                           data-toggle="lightbox"><img class="figure-img img-fluid shadow rounded"
                                                                       src="{% static 'assets/img/demo/add_handler.png' %}"
                                                                       alt="" style="width: 600px;"></a>
                                        <figcaption class="figure-caption mt-3"><i class="fas fa-image mr-2"></i>Add
                                            Handler Button
                                        </figcaption>
                                    </figure>
                                </td>
                                <td>
                                    <figure class="figure docs-figure py-3">
                                        <a href="{% static 'assets/img/demo/register_handler.png' %}"
                                           data-title="RapidPro External API service config instructions page"
                                           data-toggle="lightbox"><img class="figure-img img-fluid shadow rounded"
                                                                       src="{% static 'assets/img/demo/register_handler.png' %}"
                                                                       alt="" style="width: 600px;"></a>
                                        <figcaption class="figure-caption mt-3"><i class="fas fa-image mr-2"></i>Register
                                            Handler Form
                                        </figcaption>
                                    </figure>
                                </td>
                            </tr>
                            <br>
                            Below are the fields on the above form and what they require
                            <ol>
                                <li><code>Aggregator</code>
                        <p>
                            The name of the USSD aggregator that you want to use for example DMARK or <a
                                href="https://africastalking.com/ussd">Africa's Talking</a>)
                        </p>
                        </li>
                        <li><code>Shotcode</code>
                            <p>
                                The USSD shortcode returned by the aggregator in the response string e.g <code>255*4</code>.If aggregator does not return one in the response, please set one in <code>settings.DEFAULT_SHORT_CODE</code> and use that here.
                            </p>
                        </li>
                        <li><code>Request format</code>
                            <p>
                                This is a very important field which must be set correctly in order for the channel to
                                safely standardize aggregator Requests/Responses.. The template format is
                                provided already in that textarea as shown below.
                            <div class="docs-code-block">
                                <div class="shadow-lg rounded">
                                    <code class="code-samples hljs">
                                        {% templatetag openvariable %}short_code=ussdServiceCode}}, {% templatetag openvariable %}session_id=transactionId}}, {% templatetag openvariable %}from=msisdn}}, {% templatetag openvariable %}text=ussdRequestString}}, {% templatetag openvariable %}date=creationTime}}</code>
                                </div>
                                <br>
                                Each is a combination of two parameters, on either sides of the equal
                                sign(<code>=</code>).
                                <br>The one on the let represents the format
                                understood by RapidPro and our External channel which MUST not change.<br> The one on
                                the
                                right hand side represents the format in which the aggregator requests delivers that
                                value to our channel.
                                for example
                                <br>
                                <div class="docs-code-block">
                                    <div class="shadow-lg rounded">
                                        <code class="code-samples hljs">{% templatetag openvariable %}short_code=ussdServiceCode}}, {% templatetag openvariable %}session_id=transactionId}}, {% templatetag openvariable %}from=msisdn}}, {% templatetag openvariable %}text=ussdRequestString}}</code>
                                    </div>
                                    means the request from the aggregator API in this case say DMARK will arrive as<br>
                                    <div class="docs-code-block">
                                        <div class="shadow-lg rounded">
                                            <code class="code-samples hljs">{"ussdServiceCode:"257","transactionId":123456789,
                                                "msisdn":"25678xxxxxx","ussdRequestString":"Hello world"}</code>
                                        </div>
                                        <br>
                                        the above format will then be converted into
                                        <div class="shadow-lg rounded">
                                            <code class="code-samples hljs">
                                                {"short_code":"257", "session_id":123456789, "from":"25678xxxxxx",
                                                "text":"Hello World"}
                                            </code>
                                        </div>
                                        <br>
                                        which is understood by Rapidpro and our Channel. for example if a particular
                                        aggregator represents short_code as serviceCode, the combination to map this
                                        will be <code>{% templatetag openvariable %}short_code=serviceCode}}</code>.
                                        Please refer to your respective aggregator USSD Docs for their formats.
                                        <br><br>
                                        Note that our channel and RapidPro have the following standard formats
                                        <div class="table-responsive my-4">
                                            <table class="table table-bordered">
                                                <tbody>
                                                <tr>
                                                    <th class="theme-bg-light"><a class="theme-link" href="#"><code>session_id</code></a>
                                                    </th>
                                                    <td>for USSD session ID</td>
                                                </tr>
                                                <tr>
                                                    <th class="theme-bg-light"><a class="theme-link" href="#"><code>short_code</code></a>
                                                    </th>
                                                    <td>for USSD short codes e.g. 348</td>
                                                </tr>

                                                <tr>
                                                    <th class="theme-bg-light"><a class="theme-link"
                                                                                  href="#"><code>from</code></a></th>
                                                    <td>for the phone number in the Request.</td>
                                                </tr>

                                                <tr>
                                                    <th class="theme-bg-light"><a class="theme-link"
                                                                                  href="#"><code>text</code></a></th>
                                                    <td>for the content(message) in the request i.e. User replies.</td>
                                                </tr>
                                                <tr>
                                                    <th class="theme-bg-light"><a class="theme-link"
                                                                                  href="#"><code>date</code></a></th>
                                                    <td> (Optionally set) for the time string in the request. Note that
                                                        apart from date, your request format has to cater for all the
                                                        rest by mapping them to their equivalents in the USSD request
                                                        from a given aggregator API.
                                                    </td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                            </p>
                        </li>
                        <li><code>Response content type</code>
                            <p>
                                this is how the response to the aggregator API should be encoded(default is <code>application/json</code>)
                                (refer to your aggregator's USSD Docs for such information )
                            </p>
                        </li>
                        <li><code>Response method</code>
                            <p>
                                Specifies whether your aggregator expects a POST, GET or PUT method in the response.
                            </p>
                        </li>
                        <li><code>Signal reply string</code>
                            <p>
                                this is a keyword in the response to your aggregator's API that is used to signal
                                further interaction in the USSD session, i.e. a USSD menu with an inputbox for the end
                                user to reply. (Refer to aggregator's USSD Docs for this keyword)
                            </p>
                        </li>
                        <li><code>Signal end string</code>
                            <p>
                                this is the Keyword your aggregator uses in the response string to indicate end of USSD
                                Session in order to send a USSD prompt without an inputbox to the end user device.(Refer
                                to aggregator's USSD Docs for this keyword)
                            </p>
                        </li>
                        <li><code>Response format</code>
                            <p>
                                This field indicates the format expected by the aggregator's API in the response sent by
                                our channel. two options are so far provided.
                            </p>
                            <ul>
                                <li><code>Is Key Value</code>
                                    <p>
                                        (Default) means the aggregator API will accept the message and signal response
                                        string(seen above) from our channel if its in a json like key-value string e.g
                                    <div class="shadow-lg rounded">
                                        <code class="code-samples hljs">{"responseString":"Hello User how are you":
                                            "signal":"request"}</code>
                                    </div>
                                    </p>
                                </li>
                                <li><code>Starts With</code>
                                    <p>
                                        means the aggregator expects a string in the response body that starts with a
                                        keyword to signal end or request for interaction as seen above.
                                    </p>
                                </li>
                            </ul>
                        </li>
                        <li><code>Response Structure</code>
                            <p>
                                if option 1 (Is Key Value)in 8 above is chosen, a textarea appear
                                expecting entries similar to ones discussed under Request Format in
                                <code>(3)</code> above.<br>
                                With similar logic as in (3) above, our channel understands as follows
                                </ul>

                            </p>
                            <ul>
                                <li><code>text</code>
                                    <p>
                                        for the text(message) in the response
                                    </p>
                                </li>
                                <li><code>action</code>
                                    <p>
                                        for the signal keywords i.e (the ones that signale end of session or more
                                        interaction as discussed above). <br><br>for example if aggregator A's expected
                                        response is in this format;
                                        <br>
                                    <div class="shadow-lg rounded">
                                        <code class="code-samples hljs">
                                            {"responseString":"Hello User how are you":"signal":"Signal_keyword"}
                                        </code>
                                    </div>

                                    <br>
                                    the entry in this field should then be <br>
                                    <div class="shadow-lg rounded">
                                        <code class="code-samples hljs">
                                            {% templatetag openvariable %}text=responseString}}, {% templatetag openvariable %}action=signal}}
                                        </code>
                                    </div>
                                    </p>
                                </li>
                            </ul>
                        </li>
                        <li><code>Push support</code>
                            <p>
                                Boolean to specify whether your aggregator supports USSD PUSH protocal i.e MT USSD
                                sessions (<code>Default=False</code>)
                            </p>
                        </li>
                        </ol>
                        <br>
                        Submit this form and enjoy the power of RapidPro through USSD. You can configure multiple
                        handlers for multiple aggregators but each aggregator must have one handler depending on the
                        format of their requests/responses.
                        </p>
                    </section><!--//section-->
                    <section class="docs-section" id="item-3-5">
                        <h2 class="section-heading">Clear Timed-out sessiosn</h2>
                        <p>
                            Although Timed-out sessions allow us deduce that the channel has a connection issue to either RapidPro or the aggregator's API, they also some times lock a user inside a timed-out state. <br>
                            In order to fix this, a background task keeps deleting all timed-out sessions and this section indicates on how to configure that task.
                            <br>
                            <br>
                            Run the following command inside the project directory
                            <div class="shadow-lg rounded">
                                <code class="code-samples hljs">
                                    celery -A core worker --beat --scheduler django --loglevel=info
                                </code>
                            </div>
                            <br>
                            <b>Daemonize the above command</b>
                            <br>
                              This can be done using a process manager like <code>systemd</code> or its alternatives depending on the OS you are running. In this demo, we shall use <code>systemd</code> to create a service that runs this command in the background.
                            <br>
                            In your <code>/etc/system/systemd/</code>, create a file named <code>ussd_session_clear.service</code>. You can use any name but keep the prefix <code>.service</code>
                            <br>In this file, paste the following content;<br>
                            <div class="shadow-lg rounded">
                                <code class="code-samples hljs">
                                    [Unit]<br>
                                        &nbsp;&nbsp;Description=Clear sessions service
                                    <br>
                                    [Service]<br>
                                        &nbsp;&nbsp;WorkingDirectory=/project_folder # substitute with correct project folder<br>
                                        &nbsp;&nbsp;ExecStart= /project_folder/venv/bin/celery -A core worker --beat --scheduler django --loglevel=info
                                        &nbsp;&nbsp;Type=simple<br>

                                    [Install]<br>
                                    &nbsp;&nbsp;WantedBy=multi-user.target
                                </code>
                            </div><br>
                        Then run <code>systemctl start ussd_session_clear.service</code><br>
                        Make sure <code>systemctl status ussd_session_clear.service</code>  indicates that the service is running and active
                        </p>
                    </section>

                    <section class="docs-section" id="item-3-3">
                        <h2 class="section-heading">RapidPro USSD Flow Setup and best Practices</h2>
                        <p>
                            Although the channel does not require much changes in the normal RapidPro SMS flows, for a swift experience using this channel, you may want to revisit your SMS flow designs to best serve USSD. Below we present you our recommended best practices.<br><br>
                            <ul>
                                <li>Create a RapidPro trigger that corresponds to the <code>Trigger word</code> that was specified during step 6 under Channel config above.</li>
                                <li>If you want a single shortcode to support multiple flows, create a single flow that routes to other flows and assign a the trigger (create in above) to that flow. for example if You have 3 flows (Register flow, Login flow, and Survey flow), you can create an extra flow say <code>Link flow</code> and route the user accordingly as below.</li>
                                <ol>
                                    <li>Register</li>
                                    <li>Login</li>
                                    <li>Survey</li>
                                </ol>
                                <li>Ensure that there are no open nodes in the flows, for example if a node (a step in flow) requires a user to provide options as below;</li>
                                <ol>
                                    <li>Yes</li>
                                    <li>No</li>
                                    <li>Opt out</li>
                                    <li>Back to main menu</li>
                                </ol>
                            </ul>

                            <br>
                            Your flow should have a node that handles a scenario where a user enters a 5 or anything undesirable. This is normally provided by RapidPro using the route called <code>Other</code>. Make sure <code>Other</code> is handled and not left open. i.e. you can create a node that notifies the user of a wrong entry and routes back to waiting another entry. Failure to handle <code>Other</code> may result into bad channel behaviour which can be frustrating.
                            <ul>
                                <li>When designing your flows for USSD, make sure the user does not have to enter long responses whenever you can. e.g. provide options to pick from as numbers (1,2,3,4,5....) like in the above examples. </li>
                            <li>Its good practice to provide an option for Cancelling and routing back to the previous step or back to main menu in your flows. For example</li>
                            <ol>
                                <li>Yes</li>
                                <li>No</li>
                                <li>Back</li>
                                <li>Back to main menu</li>
                                <li>Cancel(Opt out)</li>
                            </ol>
                                <li>
                                    Lastly, RapidPro provides a flow feature which expires inactive contacts after a give period of time, make sure you specify this period during or after flow creation to avoid scenarios where a contact who dailed a shortcode a month ago and probably forgot where they stopped,comes back and picks up from where they left off. You may want to set the flows to restart these cases afresh.
                                </li>
                            </ul>
                        <br>
                        </p>
                    </section>

                    <section class="docs-section" id="item-3-4">
                        <h2 class="section-heading">Deployment (enable Live session tracking table)</h2>
                        <p>
                            We have looked at setting up a development server for this channel above. let us look at how quickly you can set up an instance for production.<br><br>
                            The External Channel applications uses <a href="https://channels.readthedocs.io/en/stable/index.html">Django Channels</a><br>
                            <br>
                            Channels is a project that takes Django and extends its abilities beyond HTTP - to handle WebSockets, chat protocols, IoT protocols, and more. Its built on a Python specification called <a href="http://asgi.readthedocs.io/">ASGI</a>
                            <br><br>
                            In order to support live session table on the dashboard i.e. whenever a user initiates a USSD session, it can be visible in realtime on the graph and table on the dashboard. This ability uses websockets which if not deployed well may disable the feature.
                            <br><br>
                            Note that this has no negative effects on the overall performance of the system. It just grants you the ability to watch USSD sessions as they are initiated in realtime. If you are excited about this feature, we offer you an easy way of getting started.
                            <ul>
                                <li>The system comes with <a href="https://pypi.org/project/daphne/">Daphne</a> which is a HTTP, HTTP2 and WebSocket protocol server for ASGI and ASGI-HTTP, developed to power Django Channels.</li>
                                <li>The system has an <code>asgi.py</code> file under <code>project_folder/core/</code> which is ready to get you started quickly. What you need to do is simply run <code>daphne -b 0.0.0.0 -p 8000 core.asgi:application</code> inside your project directory and you are good to go. You can run daphne user a python virtual environment by simply using <code>venv/bin/daphne -b 0.0.0.0 -p 8000 core.asgi:application</code></li>
                            </ul>
                        <br><br>
                        You can run this as a daemon if you want using <a href="https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&cad=rja&uact=8&ved=2ahUKEwia1-WAkcHtAhVbilwKHSD2AFgQFjAKegQIIhAC&url=https%3A%2F%2Fwiki.archlinux.org%2Findex.php%2Fsystemd&usg=AOvVaw0gaiXnpOAFuudxBlQMopBx">systemd</a> or similar projects on Linux or macOS.
                        <br><br>
                        There are also alternative ASGI servers that you can use for serving Channels as described <a href="https://channels.readthedocs.io/en/stable/deploying.html">here</a>.
                        <br><br>
                        Another important resource on this can be found <a href="https://docs.djangoproject.com/en/3.1/howto/deployment/asgi/daphne/">here</a>
                        <br><br>
                        You can as well deploy the system using wsgi and it will still work, except you won't get a live session tracking table on your dashboard. Under this setup, you can only see new USSD sessions after reloading the page. But the graphs will still give you a relatively better update of what's happening.
                        <br><br>
                        Thank You
                        <br><br>
                        Good luck.
                        </p>
                    </section>


                </article><!--//docs-article-->

                <article class="docs-article" id="section-4">
                    <header class="docs-header">
                        <h1 class="docs-heading">Other Features</h1>
                        <section class="docs-intro">
                            <p>The USSD External Channel web interface has other features. Below we look at them.</p>
                        </section>
                    </header>
                    <section class="docs-section" id="item-4-1">
                        <h2 class="section-heading">Dashboard</h2>
                        <p>
                            The dahboard provides a summary of live USSD sessions in two forms as shown in the image
                            below.<br>
                            <figure class="figure docs-figure py-3">
                                <a href="{% static 'assets/img/demo/dashboard.png' %}"
                                   data-title="Dashboard"
                                   data-toggle="lightbox"><img class="figure-img img-fluid shadow rounded"
                                                               src="{% static 'assets/img/demo/dashboard.png' %}"
                                                               alt="" style="width: 600px;"></a>
                                <figcaption class="figure-caption mt-3"><i class="fas fa-image mr-2"></i>A screenshot of
                                    the Dashboard
                                </figcaption>
                            </figure>
                            <ol>
                                <li>
                                    <h5>Bar Graph</h5>
                        <p>
                            This represents sessions on an <code>x-axis</code>(Timestamp in intervals of 5 secs) and
                            <code>y-axis</code>(No. of sessions).
                            <br>
                            The key of this graph clearly shows that sessions are tracked by status i.e.
                        <ul>
                            <li><code>Timed Out</code>:&nbsp; <b style="color:red">Red</b></li>
                            <li><code>Completed</code>:&nbsp; <b style="color:green">Green</b></li>
                            <li><code>In Progress</code>:&nbsp; <b style="color:blue">Blue</b></li>
                        </ul>
                        <b style="color:red">Attention</b> is needed when the red Bar is taller or the only visible bar.
                        This means sessions are timing out in at the USSD External channel side. i.e. The channel can
                        not reach RapidPro or RapidPro is not responding to the requests our channel forwards to it.<br>
                        Please check if your RapidPro instance is online or if it is, check if it's replying to the
                        <code>send-url</code> you set during channel cofigurations.<br>
                        You may also want to check if the <code>send-url</code> you set is correct.
                        </p>
                        </li>
                        <li>
                            <h5>Tabular Format</h5>
                            <p>
                                The table displays Live USSD Sessions, every new session is added to the top of the
                                table.
                                Where as the Bar Graph represents only three session statuses, the table adds another
                                status on top of the 3 seen above.
                                This is the <b style="color:orange">Terminated</b> status.<br>
                                Like in the Bar Graph, <b style="color:red">Red</b> calls for Attention but <b
                                    style="color:orange">Orange</b> should not raise any conserns.<br>
                                This is because USSD session termination is normal, a USSD session may expire on the end
                                User's device or they may choose to cancel it by pressing the <code>CANCEL</code> button
                                on their USSD enabled devices.<br>
                                Once this happens, the next time a this user initiates a new USSD, the last one is
                                labelled as terminated.
                                Therefore, for every terminated session, it means a user was resumed from where they
                                stopped in a given flow.


                            </p>
                        </li>
                        </ol>
                        </p>
                    </section>

                    <section class="docs-section" id="item-4-2">
                        <h2 class="section-heading">User Profile</h2>
                        <p>
                            This section handles Current user profile managment.
                            for example, editing username, email and changing the password.
                            <br>
                            The Admin user(super user) is capable of the following extra activities;
                            <ol>
                                <li><h5>Enabling/Disabling other users.</h5>
                        <p>Disabled users will not be able to log into the system.</p>
                        </li>
                        <li><h5>Inviting Users by email.</h5>
                            <p>
                                The Admin clicks, Invite User, then a a form will appear(as shown in the image below)
                                requesting for an invite email address to which on invite, a new account will be
                                created.<br>
                                This account will have a randomly generated password. and a username which will be the
                                first part of the email address before <code>@</code>.<br>
                                An email will then be sent to the address specified, with a link to the USSD External
                                channel login page and the auto generated credentials.
                                The invited user can use these to login for the first time and can change their
                                credentials once logged in.
                                <br> Note that these users won't be Admins, so they can only change their account
                                profiles, other options like <code>Invite User</code>, <code>Enable/Disable users</code>
                                won't be accessible to them.
                                <figure class="figure docs-figure py-3">
                                    <a href="{% static 'assets/img/demo/invite.png' %}"
                                       data-title="Invite User form"
                                       data-toggle="lightbox"><img class="figure-img img-fluid shadow rounded"
                                                                   src="{% static 'assets/img/demo/invite.png' %}"
                                                                   alt="" style="width: 600px;"></a>
                                    <figcaption class="figure-caption mt-3"><i class="fas fa-image mr-2"></i>Invite user
                                        by email
                                    </figcaption>
                                </figure>
                                <br>
                                Note that for emails to be sent out, and SMTP server credentials must be provided in
                                <code>core/settings.py</code>
                                below are the SMTP settings required for feature to work
                            <div class="docs-code-block rounded">
                                <code class="code-samples hljs">
                                    HOST = "http://link_to_external_channel.app" (this is your USSD External channel
                                    server link which will be sent in the email)<br>
                                    EMAIL_HOST = "smtp.domain.com" (smtp server host e.g for gmail it's
                                    smtp.gmail.com)<br>
                                    EMAIL_POST = 25 (SMTP port e.g 25, 465, 587)<br>
                                    EMAIL_HOST_USER = "example@app.com" (your email address or username on this smtp
                                    server e.g a gmail user can set this to tester@gmail.com )<br>
                                    EMAIL_HOST_PASSWORD = "xxxxx"(Your email password)
                                </code>
                            </div>
                            </p>
                        </li>
                        </ol>
                        <figure class="figure docs-figure py-3">
                            <a href="{% static 'assets/img/demo/profile.png' %}"
                               data-title="User profile page"
                               data-toggle="lightbox"><img class="figure-img img-fluid shadow rounded"
                                                           src="{% static 'assets/img/demo/profile.png' %}"
                                                           alt="" style="width: 600px;"></a>
                            <figcaption class="figure-caption mt-3"><i class="fas fa-image mr-2"></i>User profile page
                                for Admin users
                            </figcaption>
                        </figure>
                        </p>
                    </section>
                </article>

            </div>
        </div>
    </div><!--//docs-wrapper-->
{% endblock content %}

